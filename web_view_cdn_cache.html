<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDFキャッシュ切り分けテスター (WebView / CDN)</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0b0c10;
      --panel: #151820;
      --text: #e6e6e6;
      --muted: #9aa4b2;
      --accent: #5b9cff;
      --ok: #2fbf71;
      --warn: #ffb020;
      --bad: #ff5d5d;
    }
    *{box-sizing:border-box}
    body { margin: 0; font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    header { padding: 16px; background: linear-gradient(180deg, #1e2430, #141821); border-bottom: 1px solid #232a36; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0 0 8px; font-size: 18px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    input[type="url"], input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3342; background: #0f1320; color: var(--text); }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3342; background: #141a29; color: var(--text); cursor: pointer; }
    button:hover { border-color: #3a465d; }
    .btns { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .grid { display: grid; grid-template-columns: 380px 1fr; gap: 12px; padding: 12px; }
    .card { background: var(--panel); border: 1px solid #232a36; border-radius: 14px; }
    .card h2 { margin: 0; font-size: 14px; padding: 10px 12px; border-bottom: 1px solid #232a36; color: #cdd7e5; }
    .card .content { padding: 10px 12px; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .hint { color: var(--muted); font-size: 12px; }
    .kv { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; }
    iframe { width: 100%; height: 70vh; border: 0; background: #0f1320; border-radius: 0 0 14px 14px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #2a3342; }
    .badge.ok { color: var(--ok); border-color: #2f6f4c; }
    .badge.warn { color: var(--warn); border-color: #7a5c17; }
    .badge.bad { color: var(--bad); border-color: #7a2a2a; }
    .pair { display:grid; grid-template-columns: 140px 1fr; gap: 8px; align-items: start; margin: 4px 0; }
    .muted { color: var(--muted); }
    .footer { padding: 8px 12px; font-size: 12px; color: var(--muted); border-top: 1px solid #232a36; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>PDFキャッシュ切り分けテスター（WebView / CDN）</h1>
    <div class="row">
      <input id="url" type="url" placeholder="https://example.com/path/to/file.pdf" />
      <button id="paste">貼り付け</button>
    </div>
    <div class="btns">
      <button id="loadNormal">通常読み込み（<code>iframe</code>）</button>
      <button id="loadBusted">キャッシュバスター付きで読み込み（?cb=timestamp）</button>
      <button id="loadNoStore">no-storeでfetch→blob表示</button>
      <button id="probe">ヘッダー確認（HEAD→失敗時はGET range）</button>
      <button id="probeNoCache">ヘッダー確認（cache: no-store）</button>
      <span id="now" class="hint"></span>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>レスポンス診断</h2>
      <div class="content">
        <div class="pair"><div class="muted">推定結果</div><div id="verdict" class="kv">—</div></div>
        <div class="pair"><div class="muted">CDN系</div><div id="cdn" class="kv">—</div></div>
        <div class="pair"><div class="muted">ブラウザ/WebView系</div><div id="wv" class="kv">—</div></div>
        <div class="pair"><div class="muted">重要ヘッダー</div>
          <div class="kv" id="headers">—</div>
        </div>
        <div class="hint">※ ヘッダー表示にはCORS許可（<code>Access-Control-Expose-Headers</code>）が必要です。取得不可の場合「opaque」と表示されます。</div>
      </div>
      <div class="footer small">
        使い方：同じPDFを「通常」「バスター」「no-store blob」で見比べ、ヘッダー（<code>Age</code> / <code>X-Cache</code> / <code>CF-Cache-Status</code> / <code>Cache-Control</code> / <code>ETag</code> / <code>Last-Modified</code>）を確認。
      </div>
    </section>

    <section class="card" style="overflow:hidden;">
      <h2 class="flex">プレビュー <span id="mode" class="badge">—</span></h2>
      <iframe id="viewer" title="PDF Preview"></iframe>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const urlInput = $("url");
    const viewer = $("viewer");
    const nowEl = $("now");
    const modeEl = $("mode");
    const headersEl = $("headers");
    const verdictEl = $("verdict");
    const cdnEl = $("cdn");
    const wvEl = $("wv");

    function ts(){
      const d = new Date();
      nowEl.textContent = `現在時刻: ${d.toLocaleString()} (${Intl.DateTimeFormat().resolvedOptions().timeZone})`;
    }
    ts(); setInterval(ts, 1000);

    function ensureUrl() {
      const u = urlInput.value.trim();
      if (!u) { alert("PDFのURLを入力してください"); throw new Error("no url"); }
      try { new URL(u); } catch { alert("URLの形式が正しくありません"); throw new Error("bad url"); }
      return u;
    }

    function setMode(label, cls=""){
      modeEl.textContent = label;
      modeEl.className = `badge ${cls}`;
    }

    function setHeadersText(text){ headersEl.textContent = text; }

    function guessFromHeaders(h){
      const get = (k)=> h[k.toLowerCase()] ?? null;
      const hints = [];
      let cdn = [];
      let wv = [];

      const age = get('age');
      const xcache = get('x-cache');
      const cf = get('cf-cache-status');
      const cc = get('cache-control');
      const etag = get('etag');
      const lm = get('last-modified');

      if (age) cdn.push(`Age=${age}`);
      if (xcache) cdn.push(`X-Cache=${xcache}`);
      if (cf) cdn.push(`CF-Cache-Status=${cf}`);
      if (cc) hints.push(`Cache-Control=${cc}`);
      if (etag) hints.push(`ETag=${etag}`);
      if (lm) hints.push(`Last-Modified=${lm}`);

      cdnEl.textContent = cdn.length? cdn.join('\n') : '—';
      wvEl.textContent = '※ WebViewキャッシュはHTTPヘッダーからは直接検出できません。挙動比較で推定します。';

      let verdict = '情報不足（CORS未許可かヘッダーなし）';
      if (cf?.toUpperCase().includes('HIT') || xcache?.toUpperCase().includes('HIT') || (age && parseInt(age,10)>0)) {
        verdict = 'CDNキャッシュのヒットが示唆されます';
        setMode('CDNの可能性', 'warn');
      } else if (cc && /no-cache|no-store|must-revalidate/i.test(cc)) {
        verdict = 'キャッシュ抑制ヘッダーあり（CDN由来の再利用は低い）';
        setMode('抑制ヘッダー', 'ok');
      } else {
        verdict = 'CDNキャッシュの明確な兆候なし（ただし未露出の可能性あり）';
        setMode('不明', '');
      }

      verdictEl.textContent = verdict + (hints.length? `\n\n参考:\n${hints.join('\n')}` : '');
    }

    async function toHeaderMap(resp){
      const map = {};
      for (const [k,v] of resp.headers.entries()) map[k.toLowerCase()] = v;
      return map;
    }

    async function probe(url, cacheMode){
      // Try HEAD first
      try {
        const resp = await fetch(url, { method:'HEAD', cache: cacheMode||'default', mode:'cors' });
        if (resp.type === 'opaque') { setHeadersText('opaque（CORS未許可のため参照不可）'); return null; }
        const h = await toHeaderMap(resp);
        setHeadersText(Object.entries(h).map(([k,v])=>`${k}: ${v}`).join('\n')||'—');
        guessFromHeaders(h);
        return h;
      } catch(e){
        // Fallback: small ranged GET
        try {
          const resp = await fetch(url, { method:'GET', headers:{ 'Range':'bytes=0-1' }, cache: cacheMode||'default', mode:'cors' });
          if (resp.type === 'opaque') { setHeadersText('opaque（CORS未許可のため参照不可）'); return null; }
          const h = await toHeaderMap(resp);
          setHeadersText(Object.entries(h).map(([k,v])=>`${k}: ${v}`).join('\n')||'—');
          guessFromHeaders(h);
          return h;
        } catch(e2) {
          setHeadersText('ヘッダー取得に失敗しました: '+ e2.message);
          verdictEl.textContent = 'ヘッダーが取れないため推定できません（CORS/ネットワーク/認可制御をご確認ください）';
          setMode('取得失敗', 'bad');
          return null;
        }
      }
    }

    function withBuster(u){
      const url = new URL(u);
      url.searchParams.set('cb', Date.now().toString());
      return url.toString();
    }

    // --- UI actions ---
    $("paste").addEventListener('click', async()=>{
      try { urlInput.value = await navigator.clipboard.readText(); } catch {}
    });

    $("loadNormal").addEventListener('click', async()=>{
      const u = ensureUrl();
      setMode('通常読み込み');
      viewer.src = u;
    });

    $("loadBusted").addEventListener('click', async()=>{
      const u = ensureUrl();
      viewer.src = withBuster(u);
      setMode('キャッシュバスター', 'ok');
    });

    $("loadNoStore").addEventListener('click', async()=>{
      const u = ensureUrl();
      try {
        const resp = await fetch(withBuster(u), { cache:'no-store', mode:'cors' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const blob = await resp.blob();
        const blobUrl = URL.createObjectURL(blob);
        viewer.src = blobUrl; // BlobはURL差し替えと同等扱い、WebViewローカルキャッシュ影響を受けにくい
        setMode('fetch(no-store) → blob', 'ok');
      } catch(e){
        alert('no-store取得に失敗: ' + e.message);
        setMode('エラー', 'bad');
      }
    });

    $("probe").addEventListener('click', async()=>{ const u = ensureUrl(); await probe(u, 'default'); });
    $("probeNoCache").addEventListener('click', async()=>{ const u = ensureUrl(); await probe(u, 'no-store'); });

    // 初期値（必要なら差し替えてください）
    urlInput.value = '';
  </script>
</body>
</html>
